<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vanrui.app.user.dao.AppSourceDao">
  <resultMap id="BaseResultMap" type="com.vanrui.app.user.model.SourceEntity">
	    <id column="S_ID" jdbcType="BIGINT" property="sId" />
	    <result column="P_S_ID" jdbcType="BIGINT" property="psId" /> 
	    <result column="S_NAME" jdbcType="VARCHAR" property="sName" /> 
	    <result column="S_TYPE" jdbcType="INTEGER" property="sType" /> 
	    <result column="haveAuth" jdbcType="INTEGER" property="status" /> 
  </resultMap>
   
  <resultMap id="BaseResultMap01" type="com.vanrui.app.user.model.SourceEntity">
	    <id column="S_ID" jdbcType="BIGINT" property="sId" />
	    <result column="P_S_ID" jdbcType="BIGINT" property="psId" /> 
	    <result column="S_NAME" jdbcType="VARCHAR" property="sName" /> 
	    <result column="S_TYPE" jdbcType="INTEGER" property="sType" /> 
	    <result column="S_CODE" jdbcType="VARCHAR" property="sCode" /> 
	    <result column="S_ORDER" jdbcType="INTEGER" property="sOrder" /> 
	    <result column="S_URL" jdbcType="VARCHAR" property="sUrl" />  
	    <result column="S_TRACE" jdbcType="VARCHAR" property="sTrace" /> 
  </resultMap>
   
   
  <resultMap id="BaseResultMap02" type="com.vanrui.app.user.dto.RoleSourceUrlDto">
	    <result column="S_ID" jdbcType="BIGINT" property="rId" /> 
	    <result column="R_ID" jdbcType="BIGINT" property="rId" /> 
	    <result column="S_URL" jdbcType="VARCHAR" property="url" />
  </resultMap>
  
  <resultMap id="BaseResultMap03" type="com.vanrui.app.user.model.SourceAuthEntity">
	    <result column="S_ID" jdbcType="BIGINT" property="sId" /> 
	    <result column="rIds" jdbcType="VARCHAR" property="rIds" /> 
	    <result column="S_URL" jdbcType="VARCHAR" property="sUrl" />  
  </resultMap>
   
  <sql id="Base_Column_List">
    S_ID,P_S_ID,S_NAME,S_TYPE
  </sql>
  
  <sql id="Base_Column_List01">
    S_ID,P_S_ID,S_NAME,S_TYPE,S_CODE,S_ORDER,S_URL,S_TRACE
  </sql>
  
  <select id="selecDetailListByrId"  parameterType="java.lang.Long" resultMap="BaseResultMap01">
  		select  
  			<include refid="Base_Column_List01"></include>
  		from  T_APP_SOURCE  m
  		where  S_STATUS = 1  
	     AND   m.S_TYPE <![CDATA[ < ]]> 3 
  		  and  EXISTS (
  		  	select  1  from  T_REF_APPSOURCE_ROLE ref  where  ref.R_ID = #{rId} and  ref.S_ID = m.S_ID
  		  	)
  </select>
  
  <select id="selectAll"   resultMap="BaseResultMap">
  		select  
  			<include refid="Base_Column_List"></include>
  		from   T_APP_SOURCE
  		where  S_STATUS = 1  
  </select>
  
	<select id="selectAllByRoleId"  parameterType="java.lang.Long" resultMap="BaseResultMap">
		SELECT m.S_ID,m.P_S_ID,m.S_NAME,m.S_TYPE,
			( CASE WHEN ar.S_ID IS NULL THEN 0 ELSE 1 END ) haveAuth
		FROM T_APP_SOURCE m 
		LEFT JOIN t_ref_appsource_role ar ON ar.S_ID = m.S_ID AND ar.R_ID=#{roleId}
		WHERE m.S_STATUS = 1 and m.S_TYPE <![CDATA[ < ]]> 3
		ORDER BY P_S_ID ASC,S_ORDER ASC
	</select>
 
  
  <select id="selectAllrIdAndUrl"   resultMap="BaseResultMap02">
  		 SELECT  ar.R_ID,ar.S_ID,app.S_URL  
		   FROM  T_APP_SOURCE app,t_ref_appsource_role ar
		  WHERE  S_STATUS = 1 
		    AND  app.S_URL  IS NOT NULL  
		    AND  ar.S_ID = app.S_ID
  </select>
  
  <select id="selectAllWebUrlAndAuths"  resultMap="BaseResultMap03" >
  		SELECT  S_ID,S_URL,
  				(SELECT  GROUP_CONCAT(refwr.R_ID) FROM  `t_ref_appsource_role` refwr WHERE  refwr.S_ID = app.S_ID) rIds
 		  FROM  t_app_source  app 
 		 WHERE  S_URL IS NOT NULL
  </select>
  
</mapper>