<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vanrui.app.user.dao.UserOrgRefDao">
  
  <resultMap id="BaseResultMap"  type="com.vanrui.app.user.model.UserOrgRefEntity" >
  		<result column="U_ID" jdbcType="BIGINT" property="uId" />
	    <result column="OR_ID" jdbcType="BIGINT" property="orId" /> 
	    <result column="COMBINATION_CODE" jdbcType="VARCHAR" property="combinationCode" />  
	    <result column="OR_NAME" jdbcType="VARCHAR" property="orName" /> 
  </resultMap>
  
  <resultMap id="BaseResultMap01"  type="com.vanrui.app.user.dto.UserOrgRefDto" >
  		<result column="U_ID" jdbcType="BIGINT" property="uId" />
	    <result column="OR_ID" jdbcType="BIGINT" property="orId" /> 
	    <result column="COMBINATION_CODE" jdbcType="VARCHAR" property="combinationCode" /> 
	    <result column="USERNAME" jdbcType="VARCHAR" property="uName" /> 
	    <result column="OR_NAME" jdbcType="VARCHAR" property="orName" /> 
  </resultMap>
   
  <insert id="insert"  parameterType="java.util.List"  >
	    insert   into  T_REF_USER_ORGANIZATION (OR_ID,U_ID,COMBINATION_CODE,OR_NAME)
	    values
	    <foreach collection="uoRef" item="item" index="index" separator=",">
	    (
	        #{item.orId},
	        #{item.uId},
	        #{item.combinationCode},
	        #{item.orName}
	    ) 
	    </foreach> 
  </insert>
  
  <delete id="delete"  parameterType="java.lang.Long" >
  		delete  from  T_REF_USER_ORGANIZATION   where  U_ID = #{uId}
  </delete>
  
  <update id="updateByOrgId">
  		UPDATE   T_REF_USER_ORGANIZATION  
  		   SET   COMBINATION_CODE=#{combineCode} , OR_NAME=#{orgName}
  		 WHERE   OR_ID = #{orgId}
  </update>
  
  <select id="selectUserOrgRefsByUId"  parameterType="java.lang.Long" resultMap="BaseResultMap">
  		select  U_ID,OR_ID,COMBINATION_CODE,OR_NAME
  		from    T_REF_USER_ORGANIZATION
  		where   U_ID = #{uId}
  </select>
  
  <select id="selectRefsByUIdsOld"  parameterType="java.lang.Long" resultMap="BaseResultMap01">
  		select  us.U_ID,us.USERNAME,OR_ID,COMBINATION_CODE,OR_NAME
  		from    T_REF_USER_ORGANIZATION ref,(
  			select u.U_ID,u.USERNAME 
  			from T_USER u  
  			where  u.U_ID  in (
	  		<foreach collection="uIds" item="item" index="index" separator=",">
		    	#{item}
		    </foreach>
  			)
  		) us
  		where  us.U_ID =  ref.U_ID  
  </select>


	<select id="selectRefsByUIds"  parameterType="java.lang.Long" resultMap="BaseResultMap01">
  		select us.U_ID,us.USERNAME,ref.OR_ID,ref.COMBINATION_CODE,ref.OR_NAME
  		from T_REF_USER_ORGANIZATION ref 
  		INNER JOIN T_USER us ON us.U_ID = ref.U_ID AND us.U_ID IN (
  		<foreach collection="uIds" item="item" index="index" separator=",">
	    	#{item}
	    </foreach>
 			)  		
	</select>   
   
   <select id="selectuIdList"    resultType="java.lang.Long">
  		SELECT   DISTINCT  U_ID 
  		  FROM   T_REF_USER_ORGANIZATION
  		 WHERE   U_ID != #{uId}  
  		   AND   COMBINATION_CODE  LIKE   CONCAT(#{combineCode},'%')
  </select>
      
   <select id="selectUserIdList"    resultType="java.lang.Long">
  		SELECT   u.U_ID  FROM  T_USER   u 
  		 WHERE  1=1
  		 <if test=" userName != null ">
  		   AND  u.USERNAME LIKE CONCAT('%',#{userName},'%')
  		 </if> 
  		   AND  EXISTS (
				SELECT   1
				FROM   T_REF_USER_ORGANIZATION  ref
				WHERE  ref.U_ID = u.U_ID  AND  ref.COMBINATION_CODE  LIKE   CONCAT(#{combineCode},'%')
  		   )
  		   order by u.U_ID
   </select>
   
   <select id="selectUserIdListByCombineCodeList"    resultType="java.lang.Long">
  		SELECT   U_ID  FROM  T_USER   u 
  		 WHERE  u.STATUS = 1
  		 <if test=" userName != null ">
  		   AND  u.USERNAME LIKE CONCAT('%',#{userName},'%')
  		 </if> 
  		 <if test="combineCodeList != null and combineCodeList.size > 0">
  		   AND  EXISTS (
				SELECT   1
				FROM   T_REF_USER_ORGANIZATION  ref
				WHERE  ref.U_ID = u.U_ID  AND  
				<foreach collection="combineCodeList" index="index" open="(" close=")" separator="or">
				ref.COMBINATION_CODE LIKE CONCAT(#{combineCodeList[${index}]},'%')
				</foreach>
  		   )
  		 </if>
   </select>
   
    <select id="selectUserIds"  parameterType="java.lang.String"  resultType="java.lang.Long">
  		SELECT   DISTINCT ref.U_ID
		  FROM   T_REF_USER_ORGANIZATION  ref
		 WHERE   ref.COMBINATION_CODE = #{combineCode} 
   </select>
   
   <select id="selectUserIdsByCombineCodeList" parameterType="java.util.List"  resultType="java.lang.Long">
  		SELECT   DISTINCT ref.U_ID
		  FROM   T_REF_USER_ORGANIZATION  ref
		 WHERE   ref.COMBINATION_CODE in (
		 <foreach collection="combineCodeList" item="item" index="index" separator=",">
	 		#{item}
	 	</foreach>
	 	)
   </select>
   
    <select id="selectLikeUserIds"  parameterType="java.lang.String"  resultType="java.lang.Long">
  		SELECT   DISTINCT ref.U_ID
		  FROM   T_REF_USER_ORGANIZATION  ref
		 WHERE   ref.COMBINATION_CODE = #{combineCode} 
   </select>
   
  
   <select id="hasUserUnderOrganization"    resultType="java.lang.Integer">
  		SELECT 1 FROM T_REF_USER_ORGANIZATION 
  		WHERE OR_ID  = #{orgId} 
  		LIMIT 1;
  </select>
  
  
   <select id="selectWorkOrderManagers"    resultType="java.lang.Long" parameterType="java.lang.Long" >

  		SELECT UO.U_ID
		FROM  T_REF_USER_ORGANIZATION UO 
				LEFT JOIN T_REF_ROLE_USER RU ON UO.U_ID = RU.U_ID
				LEFT JOIN T_REF_APPSOURCE_ROLE AR  ON RU.R_ID = AR.R_ID
		WHERE AR.S_ID = 4 AND UO.OR_ID = #{orgId} 
		
  </select>
  
  <select id="selectTotalUser" resultType="java.lang.Integer">
    SELECT count(distinct  user.u_id) totalUser
	FROM t_ref_user_organization userOrg, t_user user
	where userOrg.u_id = user.U_ID
	and STATUS = 1
	and (
	  <foreach collection="orgCodes" item="orgCode" separator="or">
	      userOrg.COMBINATION_CODE like concat("${orgCode}","%")
	  </foreach>
	)
  
  </select>
  
  <select id="selectUserPhoneNums" resultType="java.lang.String">
    SELECT distinct  user.MOBILEPHONE
	FROM t_ref_user_organization userOrg, t_user user
	where userOrg.u_id = user.U_ID  and user.U_ID != #{uId}
	and user.STATUS = 1
	and (
	  <foreach collection="orgCodes" item="orgCode" separator="or">
	      userOrg.COMBINATION_CODE like concat("${orgCode}","%")
	  </foreach>
	)
  
  </select>
</mapper>